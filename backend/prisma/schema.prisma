// Prisma Schema for Rest Treasury Service
// Database: PostgreSQL with UUID primary keys

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Management
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // bcrypt hashed
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bankConnections  BankConnection[]
  investmentOrders InvestmentOrder[]
  secclAccounts    SecclAccount[]
  auditLogs        AuditLog[]

  @@map("users")
}

// ============================================================================
// Bank Connectivity (Plaid Integration)
// ============================================================================

model BankConnection {
  id             String    @id @default(uuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Plaid data (ENCRYPTED - accessToken is encrypted at application level)
  accessToken    String    // AES-256 encrypted Plaid access token
  itemId         String    @unique // Plaid item ID
  institutionId  String    // Plaid institution ID
  institutionName String?

  // Status tracking
  status         String    @default("ACTIVE") // ACTIVE, DISCONNECTED, ERROR
  lastSyncedAt   DateTime?
  lastSyncStatus String?   // SUCCESS, FAILED, PARTIAL

  // Soft delete
  deletedAt      DateTime?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  accounts       BankAccount[]

  @@index([userId])
  @@index([itemId])
  @@map("bank_connections")
}

model BankAccount {
  id               String         @id @default(uuid())
  bankConnectionId String
  bankConnection   BankConnection @relation(fields: [bankConnectionId], references: [id], onDelete: Cascade)

  // Plaid account data
  plaidAccountId   String         @unique // Plaid account ID
  name             String         // Account name from Plaid
  officialName     String?        // Official account name
  type             String         // checking, savings, credit, etc.
  subtype          String?        // More specific type
  mask             String?        // Last 4 digits (e.g., "1234")

  // Balance information (in cents to avoid floating point issues)
  currentBalance   Int?           // Current balance in cents
  availableBalance Int?           // Available balance in cents
  isoCurrencyCode  String         @default("USD")

  // Metadata
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  // Relations
  transactions     Transaction[]

  @@index([bankConnectionId])
  @@index([plaidAccountId])
  @@map("bank_accounts")
}

model Transaction {
  id              String      @id @default(uuid())
  bankAccountId   String
  bankAccount     BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  // Plaid transaction data
  plaidTransactionId String   @unique // Plaid transaction ID
  name            String      // Merchant/transaction name
  amount          Int         // Amount in cents (positive for spending, negative for income)
  isoCurrencyCode String      @default("USD")
  date            DateTime    // Transaction date
  pending         Boolean     @default(false)

  // Categories
  category        String[]    // Array of category hierarchy
  paymentChannel  String?     // online, in store, etc.

  // Metadata
  merchantName    String?
  location        Json?       // Store location data

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([bankAccountId])
  @@index([plaidTransactionId])
  @@index([date])
  @@map("transactions")
}

// ============================================================================
// Investment Management (Seccl Integration)
// ============================================================================

model SecclAccount {
  id               String   @id @default(uuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Seccl account identifiers
  secclAccountId   String   @unique // Seccl's account ID
  secclClientId    String   // Seccl's client ID
  firmId           String   // Seccl firm ID

  // Account details
  accountName      String
  accountType      String   // "Wrapper"
  wrapperType      String   // ISA, GIA, PENSION, JISA
  currency         String   @default("GBP")
  status           String   @default("Active")

  // Balances (in pence)
  cashBalance      Int      @default(0)
  totalValue       Int      @default(0)

  // Metadata
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  investmentOrders InvestmentOrder[]
  positions        InvestmentPosition[]

  @@index([userId])
  @@index([secclAccountId])
  @@map("seccl_accounts")
}

model InvestmentOrder {
  id               String        @id @default(uuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  secclAccountId   String
  secclAccount     SecclAccount  @relation(fields: [secclAccountId], references: [id], onDelete: Cascade)

  // Seccl transaction group data
  linkId           String?       // Seccl transaction group link ID
  paymentId        String?       // Seccl payment transaction ID
  orderId          String?       // Seccl order transaction ID

  // Order details
  fundId           String        // Money market fund identifier (assetId)
  fundName         String?
  amount           Int           // Amount in pence
  currency         String        @default("GBP")

  // Order status
  status           String        @default("PENDING") // PENDING, PAYMENT_COMPLETED, ORDER_COMPLETED, FAILED

  // Idempotency (CRITICAL for financial operations)
  idempotencyKey   String        @unique

  // Execution details
  executedAt       DateTime?
  executedQuantity Int?          // Shares purchased
  executionPrice   Float?        // Price per share
  executedAmount   Int?          // Actual filled amount in pence
  failureReason    String?

  // Audit
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([userId])
  @@index([secclAccountId])
  @@index([status])
  @@index([createdAt])
  @@map("investment_orders")
}

model InvestmentPosition {
  id               String        @id @default(uuid())
  userId           String

  secclAccountId   String
  secclAccount     SecclAccount  @relation(fields: [secclAccountId], references: [id], onDelete: Cascade)

  // Seccl position data
  secclPositionId  String        @unique // Format: {accountId}|{positionType}|{isin}

  // Position details
  fundId           String        // Money market fund identifier (assetId)
  fundName         String
  isin             String?       // International Securities ID
  quantity         Int           // Shares held
  bookValue        Int           // Original cost in pence
  currentValue     Int           // Current value in pence
  growth           Int           @default(0) // Absolute profit/loss in pence
  growthPercent    Float         @default(0) // Percentage return
  currency         String        @default("GBP")

  // Metadata
  lastUpdatedAt    DateTime      @default(now())
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([userId])
  @@index([secclAccountId])
  @@index([fundId])
  @@map("investment_positions")
}

// ============================================================================
// Audit Logging (Compliance & Security)
// ============================================================================

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Action details
  action       String   // e.g., "INVESTMENT_ORDER_CREATED", "BANK_CONNECTION_DELETED"
  resourceType String   // e.g., "INVESTMENT_ORDER", "BANK_CONNECTION"
  resourceId   String?  // UUID of the affected resource

  // Request context
  ipAddress    String?
  userAgent    String?

  // Additional data
  metadata     Json?    // Flexible JSON for additional context

  // Timestamp
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("audit_logs")
}
